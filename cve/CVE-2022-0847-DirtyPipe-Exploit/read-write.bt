#!/usr/bin/env bpftrace
/**
 * File: read-write.bt
 * Author: Rong Tao (rongtao@cestc.cn)
 * Time: 2022-03-10
 *
 * CVE-2022-0847-DirtyPipe-Exploit
 * 1. https://dirtypipe.cm4all.com/
 * 2. https://github.com/Arinerron/CVE-2022-0847-DirtyPipe-Exploit/
 */

#include <linux/mm.h>

BEGIN
{
	printf("Tracing CVE-2022-0847-DirtyPipe-Exploit.\n");
}

kprobe:iomap_write_end,
kprobe:__xfs_filemap_fault
{
	@write_probe[pid] = 1;
}

kprobe:iomap_write_actor
{
	@write_probe[pid] = 2;
}

kretprobe:pagecache_get_page
/@write_probe[pid] != 0/
{
	$page = (struct page *)retval;
	//printf("Page %-16lx\n", $page);
	if (@write_probe[pid] == 1) {
		printf("Write: %-16lx, %-5d\n", $page->flags, $page->page_type);
	} else if (@write_probe[pid] == 2) {
		printf("Read : %-16lx, %-5d\n", $page->flags, $page->page_type);
	}
	clear(@write_probe);
}
